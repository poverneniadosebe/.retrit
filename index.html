<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Жіночий ретрит «Повернення до себе» • Карпати 11.09–15.09.2025</title>
  <meta name="theme-color" content="#8069be" />
  <meta name="description" content="Жіночий ретрит у Карпатах про м’яке повернення до себе: медитації, ранкова йога, стояння на цвяхах, МАК-сесії, трансформаційна гра «Ліла», SPA, джипінг до Синевиру, підйом на гору Гемба. Дбайлива атмосфера, сповільнення, безпека й підтримка. Квитки, трансфер, проживання — у вартості." />

  <!-- Favicon & PWA manifest (ставятся скриптом) -->
  <link id="favicon" rel="icon" href="">
  <link id="appleicon" rel="apple-touch-icon" href="">
  <link id="manifestLink" rel="manifest" href="">

  <!-- performance hints -->
  <link rel="preconnect" href="https://i.ibb.co" crossorigin />
  <link rel="dns-prefetch" href="//i.ibb.co" />
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin />
  <link rel="dns-prefetch" href="//images.weserv.nl" />
  <link rel="preconnect" href="https://cdn.statically.io" crossorigin />
  <link rel="dns-prefetch" href="//cdn.statically.io" />
  <link rel="preconnect" href="https://i0.wp.com" crossorigin />
  <link rel="dns-prefetch" href="//i0.wp.com" />
  <link rel="preconnect" href="https://r.jina.ai" crossorigin />
  <link rel="dns-prefetch" href="//r.jina.ai" />

  <style>
    :root{
      --bg-1:#8069be; --bg-2:#715aad; --bg-3:#9179c9;
      --glass: rgba(255,255,255,.08);
      --border:#ffffff26;
      --text:#f8f5ff; --muted:#e7deffcc;
      --shadow:0 18px 40px rgba(0,0,0,.30);
      --radius:18px;
    }
    *{box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; text-rendering:optimizeLegibility}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:Arial,Helvetica,sans-serif; line-height:1.6;
      background:
        radial-gradient(720px 480px at 22% -8%, #d7c8ff30 0%, transparent 60%),
        radial-gradient(680px 440px at 108% 24%, #d2c1ff26 0%, transparent 65%),
        linear-gradient(150deg,var(--bg-1),var(--bg-2) 52%, var(--bg-3) 100%);
      overflow-x:hidden;
    }
    body::before{
      content:""; position:fixed; inset:-20%;
      background:
        radial-gradient(56% 36% at 72% 22%, #efe6ff20 0%, transparent 60%),
        radial-gradient(50% 34% at 22% 82%, #f6eeff16 0%, transparent 60%);
      filter:blur(42px); z-index:-2; animation:float 42s linear infinite alternate; opacity:.85;
    }
    @keyframes float{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-3%,2%,0) scale(1.05)}}

    #sparkles{position:fixed; inset:0; z-index:-1; pointer-events:none;}

    .wrap{max-width:980px;margin:0 auto;padding:22px}
    header{text-align:center;padding:28px 0 16px}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--border);color:var(--muted);font-weight:700;letter-spacing:.08em}
    h1{margin:14px auto 8px;font-size:clamp(28px,4.5vw,44px);line-height:1.18;font-weight:800;letter-spacing:.3px;text-align:center;text-shadow:0 2px 24px #0006;text-wrap:balance;max-width:900px}
    .sub{margin:0 auto 18px;font-size:clamp(14px,2.6vw,18px);color:var(--muted);max-width:900px;text-align:center;text-wrap:pretty}

    /* ======= ГАЛЕРЕЯ ======= */
    .carousel{position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#221a41;margin:0 auto}
    .viewport{position:relative;width:100%;aspect-ratio:16/9;overflow:hidden!important;background:#221a41}
    .slides{display:flex;width:100%;height:100%;transform:translateX(0);transition:transform .5s ease;will-change:transform;user-select:none;touch-action:pan-y;overflow:hidden!important}
    .slide{flex:0 0 100%;height:100%;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .slide picture,.slide img{width:100%;height:100%;object-fit:cover;object-position:center}
    .slide img{image-rendering:auto;-webkit-user-drag:none;user-select:none;pointer-events:none;contain:paint;transform:translateZ(0)}
    .viewport::-webkit-scrollbar,.slides::-webkit-scrollbar,.slide::-webkit-scrollbar{width:0;height:0}

    .ph{position:absolute;inset:0;background:
      radial-gradient(60% 80% at 50% 20%, #32265c, transparent 70%),
      linear-gradient(180deg,#2c2154,#221a41);animation:ph 1.4s ease-in-out infinite alternate}
    @keyframes ph{0%{opacity:.55}100%{opacity:.85}}

    .loader{position:absolute;top:50%;left:50%;width:20px;height:20px;border-radius:50%;
      border:3px solid rgba(255,255,255,.32);border-top-color:#fff;transform:translate(-50%,-50%);
      pointer-events:none;z-index:2;display:none;animation:spin .8s linear infinite;box-shadow:0 0 0 6px rgba(0,0,0,.12)}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0)}100%{transform:translate(-50%,-50%) rotate(360deg)}}

    .navBtn{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#fff;background:rgba(28,18,60,.55);border:1px solid #ffffff2a;backdrop-filter:blur(6px);cursor:pointer;opacity:.95;transition:transform .15s ease,filter .2s ease}
    .navBtn:hover{transform:translateY(-50%) scale(1.06)}
    .navPrev{left:10px}.navNext{right:10px}
    .dots{position:absolute;left:0;right:0;bottom:10px;display:flex;gap:8px;justify-content:center}
    .dot{width:8px;height:8px;border-radius:50%;background:#ffffff60;box-shadow:0 0 0 2px #0003 inset}
    .dot.active{background:#fff}

    /* ======= КАРТКИ ======= */
    .card{background:linear-gradient(180deg,#6a54a099,#54428f99);border:1px solid var(--border);border-radius:var(--radius);padding:22px clamp(16px,5vw,28px);margin:20px auto;backdrop-filter:blur(8px);box-shadow:var(--shadow);text-align:center}
    .card h2{margin:0 0 12px;font-size:clamp(22px,3.6vw,30px);font-weight:800;letter-spacing:.2px;text-align:center;text-wrap:balance}
    .card p,ul.clean{max-width:880px;margin:10px auto;text-align:justify;text-wrap:pretty;word-break:normal;overflow-wrap:normal;hyphens:none}
    .grid2{display:grid;gap:16px}
    @media(min-width:820px){.grid2{grid-template-columns:1.2fr .8fr}}
    ul.clean{padding:0;list-style:disc inside}
    ul.clean li{margin:10px 0}
    .pill{display:inline-block;margin:6px 6px 0 0;padding:6px 10px;font-size:14px;border-radius:999px;border:1px solid var(--border);color:#f7f2ff;background:#ffffff22}

    .price{font-size:clamp(22px,4.4vw,34px);margin:0 0 12px;font-weight:800;text-align:center}
    .cta{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .btn{appearance:none;border:0;cursor:pointer;padding:14px 20px;border-radius:14px;font-weight:800;letter-spacing:.3px;text-decoration:none;display:inline-flex;align-items:center;gap:10px;color:#221a41;background:linear-gradient(180deg,#efe3ff,#c9aef7);box-shadow:0 10px 24px #0005,inset 0 1px 0 #fff7;transition:transform .12s ease,filter .2s ease}
    .btn:hover{transform:translateY(-1px);filter:saturate(1.04)}
    .btn:active{transform:translateY(0)}
    .note{color:var(--muted);font-size:14px;text-align:center}

    .reveal{opacity:0;transform:translateY(14px);transition:all .8s ease}
    .reveal.show{opacity:1;transform:none}

    footer{padding:24px 0 40px;text-align:center;color:#e7dcffcc;font-size:14px}
    a{color:#fff}
    @media (prefers-reduced-motion: reduce){
      body::before{animation:none}
      #sparkles{display:none}
      .reveal{transition:none}
    }
  </style>
</head>
<body>
  <canvas id="sparkles"></canvas>

  <div class="wrap">
    <header class="reveal show">
      <span class="badge">Карпати • 11.09–15.09.2025</span>
      <h1>Жіночий ретрит «Повернення до себе»</h1>
      <p class="sub">медитації, ранкова йога, стояння на цвяхах, МАК-сесії, трансформаційна гра «Ліла»</p>
    </header>

    <!-- ======= ГАЛЕРЕЯ ======= -->
    <section class="carousel reveal" id="gallery" aria-label="Галерея світлин">
      <div class="viewport">
        <div class="slides" id="slides"></div>
        <div class="loader" id="galleryLoader" aria-hidden="true"></div>
      </div>
      <button class="navBtn navPrev" id="prev" aria-label="Попереднє фото" type="button">‹</button>
      <button class="navBtn navNext" id="next" aria-label="Наступне фото" type="button">›</button>
      <div class="dots" id="dots" aria-hidden="true"></div>
    </section>

    <!-- ======= ПРО РЕТРИТ ======= -->
    <section class="card reveal">
      <h2>Про ретрит</h2>
      <p>Ці дні — про <b>тишу всередині</b>, м’яке сповільнення та повернення до себе. Ми створюємо безпечний простір, де можна нарешті видихнути, відчути тіло, помітити справжні потреби й дбайливо дати їм місце.</p>
      <p>Практики підібрані так, щоб зняти напругу, відновити енергію й повернути <b>ясність</b>. Ви зможете прожити емоції, які потребують уваги, і побачити нові рішення — без тиску, з повагою до власного темпу.</p>
      <div style="text-align:center;margin-top:10px">
        <span class="pill">Медитації</span>
        <span class="pill">Ранкова йога</span>
        <span class="pill">Стояння на цвяхах (садху)</span>
        <span class="pill">МАК-сесії</span>
        <span class="pill">Трансформаційна гра «Ліла»</span>
      </div>
    </section>

    <!-- ======= ЩО НА ТЕБЕ ЧЕКАЄ ======= -->
    <section class="card reveal">
      <h2>Що на тебе чекає</h2>
      <ul class="clean">
        <li><b>Медитації</b> — заспокоєння нервової системи, відчуття опори й тепла в тілі.</li>
        <li><b>Гра «Ліла»</b> — м’який спосіб побачити себе збоку, отримати підказки й інсайти для рішень.</li>
        <li><b>Стояння на цвяхах</b> — зустріч зі страхом і вихід у силу через усвідомлене дихання.</li>
        <li><b>Ранкова йога</b> — легкість, баланс, м’яка сила й контакт із собою.</li>
        <li><b>МАК-сесії</b> — відповіді з підсвідомого, ясність наступних кроків.</li>
      </ul>
    </section>

    <!-- ======= Як минає день ======= -->
    <section class="card reveal">
      <h2>Як минає день</h2>
      <p>Ранок — тиша, дихання й йога. День — природа, SPA або подорож Карпатами. Вечір — м’які інтеграційні практики, тепле коло, час для себе.</p>
    </section>

    <!-- ======= ЩО ВХОДИТЬ ======= -->
    <section class="card reveal">
      <h2>Що входить у вартість</h2>
      <ul class="clean">
        <li><b>Квитки на поїзд</b>: виїзд з Одеси о <b>14:41</b> потягом «Одеса—Ужгород», вихід на ст. <b>Воловець</b> о <b>06:30</b>.</li>
        <li><b>Трансфер</b> з Воловця до Пилипця й назад.</li>
        <li><b>Проживання</b> у затишному готелі в Пилипці.</li>
        <li><b>SPA-день</b> для відновлення (сауна/басейн/релакс-зона).</li>
        <li><b>Джипінг</b> Карпатами та <b>подорож до озера Синевир</b>.</li>
        <li><b>Підйом на гору Гемба</b></li>
        <li><b>Щоденні практики</b>: медитації, ранкова йога, стояння на цвяхах, МАК-сесії, «Ліла».</li>
      </ul>
    </section>

    <!-- ======= ПІСЛЯ РЕТРИТУ ======= -->
    <section class="card reveal">
      <h2>Що відчуєш після</h2>
      <p>Більше легкості й внутрішнього спокою. Ближчий контакт із тілом і почуттями. Розуміння, куди рухатися далі — без зайвого шуму, з опорою на себе.</p>
    </section>

    <!-- ======= CTA ======= -->
    <section class="card reveal" id="buy">
      <h2>Бронювання</h2>
      <p class="price">Ціна: <b>15 000 гривень</b> — усе перелічене вище входить у вартість</p>
      <div class="cta">
        <a class="btn" href="https://t.me/irinazerkalo_dushi" target="_blank" rel="noopener" aria-label="Придбати участь у Telegram">💫 Забронювати</a>
      </div>
    </section>

    <footer class="reveal">© 2025 «Повернення до себе». Карпати, Пилипець • 11–15 вересня 2025</footer>
  </div>

  <script>
    /* ================== ICON + MANIFEST ================== */
    const ibbIconPage = "https://ibb.co/WNkz2hXP";

    /* ---------- helpers ---------- */
    const LS_TTL_MS = 30*24*60*60*1000;
    const now = () => Date.now();
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const weserv = (url, dpr=2) => `https://images.weserv.nl/?url=${encodeURIComponent(url)}&output=webp&dpr=${dpr}&il`;
    const staticallyCdn = (url) => { try{const u=new URL(url); return `https://cdn.statically.io/img/${u.hostname}${u.pathname}?f=webp`;}catch(e){return url;} };
    const wpcom = (url) => `https://i0.wp.com/${url.replace(/^https?:\/\//,'')}`;

    function lsGet(key){ try{const raw=localStorage.getItem(key); if(!raw) return null; const {v,t}=JSON.parse(raw); if(now()-t>LS_TTL_MS){localStorage.removeItem(key);return null;} return v;}catch(e){return null} }
    function lsSet(key,v){ try{localStorage.setItem(key,JSON.stringify({v,t:now()}));}catch(e){} }

    function testImage(src, timeout=7000){
      return new Promise((resolve)=>{
        const im = new Image();
        let done=false; const to=setTimeout(()=>{if(!done){done=true;resolve(false)}},timeout);
        im.onload=()=>{if(!done){done=true;clearTimeout(to);resolve(true)}};
        im.onerror=()=>{if(!done){done=true;clearTimeout(to);resolve(false)}};
        im.referrerPolicy="no-referrer";
        im.decoding="async";
        im.src=src+(src.includes("?")?"&":"?")+"v="+Math.random().toString(36).slice(2);
      });
    }

    async function fetchOgImageViaProxy(ibbPageUrl){
      const naked = ibbPageUrl.replace(/^https?:\/\//,'');
      const probes = [
        `https://r.jina.ai/https://${naked}`,
        `https://r.jina.ai/http://${naked}`
      ];
      for(const probe of probes){
        try{
          const txt = await fetch(probe, {cache:'no-store', redirect:'follow'}).then(r=>r.ok?r.text():Promise.reject());
          const directMatch = txt.match(/https?:\/\/i\.ibb\.co\/[^\s"'<>]+\.(?:jpg|jpeg|png|webp)/i);
          if(directMatch && await testImage(directMatch[0])) return directMatch[0];
          const og = txt.match(/property=["']og:image["']\s+content=["']([^"']+)["']/i);
          if(og && await testImage(og[1])) return og[1];
        }catch(e){}
      }
      return null;
    }

    async function resolveIbb(ibbPageUrl){
      const id = ibbPageUrl.split("/").pop().replace(/\?.*/, '');
      const key = "ibb:best:"+id;
      const cached = lsGet(key);
      if(cached && await testImage(cached, 2500)) return cached;

      const og = await fetchOgImageViaProxy(ibbPageUrl);
      if(og){ lsSet(key, og); return og; }

      for(const ext of ["webp","jpg","jpeg","png"]){
        const guess = `https://i.ibb.co/${id}/${id}.${ext}`;
        if(await testImage(guess)){ lsSet(key, guess); return guess; }
      }

      for(const u of [weserv(ibbPageUrl), staticallyCdn(ibbPageUrl), wpcom(ibbPageUrl)]){
        if(await testImage(u)){ lsSet(key, u); return u; }
      }
      return null;
    }

    /* ================== PWA ICON ================== */
    (async ()=>{
      const bestIcon = await resolveIbb(ibbIconPage) || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB...";
      document.getElementById("favicon").href = bestIcon;
      document.getElementById("appleicon").href = bestIcon;

      const manifest = {
        name:"Жіночий ретрит — Душа без масок",
        short_name:"Ретрит",
        start_url:".", display:"standalone",
        background_color:"#8069be", theme_color:"#8069be",
        icons:[
          {src:bestIcon,sizes:"192x192",type:"image/png",purpose:"any maskable"},
          {src:bestIcon,sizes:"512x512",type:"image/png",purpose:"any maskable"}
        ]
      };
      const blob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
      document.getElementById("manifestLink").href = URL.createObjectURL(blob);
    })();

    /* ================== ГАЛЕРЕЯ (прямі посилання) ================== */
    const ibbItems = [
      {page:"https://ibb.co/mC6tPhyp", src:"https://i.ibb.co/d0G6HkpZ/vodospad-shypit-3.jpg", alt:"vodospad-shypit-3"},
      {page:"https://ibb.co/pjfk24r5", src:"https://i.ibb.co/23vpqcYH/verkhovynalife-benjola-hoidalka-2-1.webp", alt:"verkhovynalife-benjola-hoidalka-2-1"},
      {page:"https://ibb.co/N2JyQJ4K", src:"https://i.ibb.co/HTbH1bJq/verkhovynalife-benjola-hoidalka-2-3.jpg", alt:"verkhovynalife-benjola-hoidalka-2-3"},
      {page:"https://ibb.co/4nwV4ZTr", src:"https://i.ibb.co/MxyCPDV0/image.jpg", alt:"image"},
      {page:"https://ibb.co/N21d2zKz", src:"https://i.ibb.co/pjWBjpdp/synevyr-pereval-2.jpg", alt:"synevyr-pereval-2"},
      {page:"https://ibb.co/hRh6v8P9", src:"https://i.ibb.co/zhjMwfyx/248887204-4555383451208509-5727271300579284772-n-1024x685.jpg", alt:"karpaty-1"},
      {page:"https://ibb.co/nqdZJ9N3", src:"https://i.ibb.co/BHWdMb54/image.jpg", alt:"image-2"},
      {page:"https://ibb.co/DfTSTscH", src:"https://i.ibb.co/F4CjCNZL/1620817067-12-pibig-info-p-yoga-v-lesu-priroda-krasivo-foto-13.jpg", alt:"yoga-forest"},
      {page:"https://ibb.co/4wYj5C1Q", src:"https://i.ibb.co/sp6FMcWB/yoga-1.jpg", alt:"yoga-1"},
      {page:"https://ibb.co/xqL9yq3T", src:"https://i.ibb.co/0y24kyQb/1200px-Lake-Synevyr.jpg", alt:"Lake Synevyr"},
      {page:"https://ibb.co/0yMLq7hW", src:"https://i.ibb.co/VYSGV12h/1508689491-1508686401-ozero-sinevir-2.jpg", alt:"Synevyr-2"},
      {page:"https://ibb.co/5gqdrNbV", src:"https://i.ibb.co/8LFJrW1V/photo-2025-08-23-23-23-21.jpg", alt:"photo-21"},
      {page:"https://ibb.co/1YRhzJRM", src:"https://i.ibb.co/7xr8kNrQ/photo-2025-08-23-23-23-20-2.jpg", alt:"photo-20-2"},
      {page:"https://ibb.co/kgXK9tMS", src:"https://i.ibb.co/gMJyPx6R/photo-2025-08-23-23-23-22.jpg", alt:"photo-22"},
      {page:"https://ibb.co/tMyL5fSc", src:"https://i.ibb.co/kgYmFnp0/photo-2025-08-23-23-23-20.jpg", alt:"photo-20"},
      {page:"https://ibb.co/Rpb4ZSCG", src:"https://i.ibb.co/kgB6kyhV/1508689396-1508686392-ozero-sinevir-3.jpg", alt:"Synevyr-3"}
    ];

    const slidesEl = document.getElementById("slides");
    const dotsEl = document.getElementById("dots");
    const loader = document.getElementById("galleryLoader");
    const showLoader = (v)=> loader.style.display = v ? "block" : "none";

    // Слайды с плейсхолдерами
    ibbItems.forEach((item,i)=>{
      const slide = document.createElement("div");
      slide.className="slide";
      slide.dataset.page = item.page;
      if(item.src) slide.dataset.src = item.src;

      const ph = document.createElement("div"); ph.className="ph"; slide.appendChild(ph);

      const pic = document.createElement("picture");
      const sWebp = document.createElement("source"); sWebp.type="image/webp"; pic.appendChild(sWebp);

      const img = document.createElement("img");
      img.alt = item.alt || `Фото ${i+1}`;
      img.loading = i===0 ? "eager" : "lazy";
      img.decoding="async"; img.fetchPriority = i===0 ? "high" : "auto";
      img.referrerPolicy="no-referrer"; img.crossOrigin="anonymous"; img.style.opacity="0";

      img.addEventListener('load', ()=>{ ph.remove(); img.style.opacity="1"; if(currentIndex===i) showLoader(false); });
      img.addEventListener('error', ()=>{
        // если прямой src вдруг не открылся — пробуем через прокси
        const direct = slide.dataset.src;
        if(direct && !img.dataset.fallback){
          img.dataset.fallback = "1";
          img.src = weserv(direct,2);
          img.srcset = `${weserv(direct,1)} 1x, ${weserv(direct,2)} 2x, ${weserv(direct,3)} 3x`;
        }
        showLoader(false);
      });

      pic.appendChild(img); slide.appendChild(pic); slidesEl.appendChild(slide);

      const dot = document.createElement("span"); dot.className="dot"; dotsEl.appendChild(dot);
    });

    // (опционально) Фолбек-розв'язка для тех, у кого нет прямого src
    const resolvedMap = new Map();
    let activeResolvers = 0;
    const maxParallel = 2;
    const queue = [];

    async function resolveQueued(pageUrl){
      if(!pageUrl) return null;
      if(resolvedMap.has(pageUrl)) return resolvedMap.get(pageUrl);
      if(activeResolvers >= maxParallel){
        await new Promise(res=>queue.push(res));
      }
      activeResolvers++;
      try{
        const direct = await resolveIbb(pageUrl);
        resolvedMap.set(pageUrl, direct);
        return direct;
      }finally{
        activeResolvers--;
        const next = queue.shift(); if(next) next();
      }
    }

    async function injectImageFor(index){
      const slide = slidesEl.children[index]; if(!slide) return;
      const img = slide.querySelector("img");
      if(img && img.src) return;

      showLoader(true);

      const direct = slide.dataset.src;
      if(direct){
        const sWebp = slide.querySelector("source[type='image/webp']");
        sWebp.srcset = `${weserv(direct,1)} 1x, ${weserv(direct,2)} 2x, ${weserv(direct,3)} 3x`;
        sWebp.sizes = "(max-width: 980px) 100vw, 980px";

        img.src = direct;
        img.srcset = `${direct} 1x, ${weserv(direct,2)} 2x, ${weserv(direct,3)} 3x`;
        img.sizes = "(max-width: 980px) 100vw, 980px";
        return;
      }

      // если вдруг у элемента нет прямого src — фолбек: пытаемся получить по странице
      const page = slide.dataset.page;
      const resolved = await resolveQueued(page);
      if(resolved){
        const sWebp = slide.querySelector("source[type='image/webp']");
        sWebp.srcset = `${weserv(resolved,1)} 1x, ${weserv(resolved,2)} 2x, ${weserv(resolved,3)} 3x`;
        sWebp.sizes = "(max-width: 980px) 100vw, 980px";
        img.src = resolved;
        img.srcset = `${resolved} 1x, ${weserv(resolved,2)} 2x, ${weserv(resolved,3)} 3x`;
        img.sizes = "(max-width: 980px) 100vw, 980px";
      }else{
        showLoader(false);
      }
    }

    let currentIndex = 0;
    function initCarousel(){
      const dots = Array.from(document.querySelectorAll('.dot'));
      const total = slidesEl.children.length;

      const goTo = async(i)=>{
        currentIndex = (i+total)%total;
        slidesEl.style.transform = `translateX(-${currentIndex*100}%)`;
        dots.forEach((d,di)=>d.classList.toggle('active', di===currentIndex));
        await injectImageFor(currentIndex);
        injectImageFor((currentIndex+1)%total);
        injectImageFor((currentIndex+2)%total);
      };

      document.getElementById('prev').addEventListener('click', ()=>goTo(currentIndex-1));
      document.getElementById('next').addEventListener('click', ()=>goTo(currentIndex+1));

      goTo(0).then(()=>{
        injectImageFor(1);
        // тихое «препрогрузить» следующие, чтобы листалось мгновенно
        (async ()=>{
          for(const item of ibbItems){
            if(item.src) continue; // у нас уже прямой src
            await resolveQueued(item.page);
            await sleep(250);
          }
        })();
      });
    }
    initCarousel();

    /* ================== REVEAL ================== */
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('show'); });
    },{threshold:0.14});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

    /* ================== SPARKLES ================== */
    const canvas = document.getElementById('sparkles'); const ctx = canvas.getContext('2d');
    let W=0,H=0,stars=[];
    function resize(){ const dpr=Math.min(window.devicePixelRatio||1,2); W=canvas.width=Math.floor(innerWidth*dpr); H=canvas.height=Math.floor(innerHeight*dpr); canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; ctx.setTransform(1,0,0,1,0,0);}
    function makeStars(n=84){ stars=new Array(n).fill(0).map(()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+0.6,a:Math.random()*0.5+0.2,sp:(Math.random()*0.6+0.3)*0.004,t:Math.random()*Math.PI*2}));}
    function step(){ ctx.clearRect(0,0,W,H); for(const s of stars){ s.t+=s.sp; const a=s.a*(0.55+0.45*Math.sin(s.t)); const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*4); g.addColorStop(0,`rgba(255,255,255,${a})`); g.addColorStop(1,`rgba(255,255,255,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*4,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(step); }
    resize(); makeStars(84); requestAnimationFrame(step);
    addEventListener('resize', ()=>{resize(); makeStars(stars.length);});
  </script>
</body>
</html>
